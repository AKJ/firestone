This is a copy/paste from Manastorm. If things go well, I'll extract this code in a shared module